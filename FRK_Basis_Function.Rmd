---
title: "Fixed Rank Kriging - Basis Generation"
author: "Qi Wang"
date: "2023/3/12"
output: pdf_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(FRK)
library(spNNGP)
library(ggplot2)
library(maps)
library(MBA)
library(fields)
library(sp)
```

# Step 1: Load the Data and Transformation

```{r}
us_soc <- read.csv(here::here("us_soc1.csv"))
us_map <- map_data("state", region=c("alabama", "arizona", "arkansas", "california", "colorado", "connecticut",
                                     "delaware", "florida", "georgia", "idaho", "illinois", "indiana",
                                     "iowa", "kansas", "kentucky", "louisiana", "maine", "maryland",
                                     "massachusetts", "michigan", "minnesota", "mississippi", "missouri",
                                     "montana", "nebraska", "nevada", "new hampshire", "new jersey",
                                     "new mexico", "new york", "north carolina", "north dakota", "ohio",
                                     "oklahoma", "oregon", "pennsylvania", "rhode island", "south carolina",
                                     "south dakota", "tennessee", "texas", "utah", "vermont", "virginia",
                                     "washington", "west virginia", "wisconsin", "wyoming"))
```


```{r}
set.seed(0)
us_soc$long <- us_soc$long + rnorm(nrow(us_soc), 0, sd = 0.001)
us_soc$lat <- us_soc$lat + rnorm(nrow(us_soc), 0, sd = 0.001)
long <- us_soc$long
lat <- us_soc$lat
coordinates(us_soc) <- ~ long + lat
```

# Step 2: Based on the data, we generate the basis functions with function auto_basis

Here, one thing needs to be careful about is the nres argument, noticing that we want to rearrange it to an image pixos, we need to figure out how each level of resolution is ordered before going deeper. 
```{r}
set.seed(0)
gridbasis1 <- auto_basis(mainfold = plane(), data = us_soc, nres = 1, type = "Gaussian", regular = 1)
gridbasis2 <- auto_basis(mainfold = plane(), data = us_soc, nres = 2, type = "Gaussian", regular = 1)
show_basis(gridbasis2) + 
  coord_fixed() +
  xlab("Longitude") +
  ylab("Latitude")

```
# Step 3: Based on the basis function, expand the location parameters.
```{r}
basis_soc1 <- matrix(NA, nrow = nrow(us_soc), ncol = length(gridbasis1@fn))
for (i in 1:length(gridbasis1@fn)) {
  basis_soc1[,i] <- gridbasis1@fn[[i]](coordinates(us_soc))
}

basis_soc2 <- matrix(NA, nrow = nrow(us_soc), ncol = length(gridbasis2@fn))
for (i in 1:length(gridbasis2@fn)) {
  basis_soc2[,i] <- gridbasis2@fn[[i]](coordinates(us_soc))
}


```

I separated the cases of resolution level 1 and 2, and found them are arranged in order. The first 21 are the big circles, and the rest are the small circles. Here I will only use the second smaller resolution one. and it's a 9 by 22 matrix.

```{r}
basis_use <- basis_soc2[,-(1:ncol(basis_soc1))]

land <- model.matrix(~ -1 + us_soc$landuse)

fix_eff <- cbind(long, lat, land)

colnames(fix_eff) <- c("long","lat","land C","land F","land P","land R","land W","land X")

# How deep and how large the resolution should we use? corresponds to the depth generated by the auto_basis res layer.
depth <- 2
shape_row <- length(table(gridbasis2@df[which(gridbasis2@df$res == depth) , 2 ]))
shape_col <- length(table(gridbasis2@df[which(gridbasis2@df$res == depth) , 1 ]))
```

```{r}
basis_arr <- array(NA, dim = c(nrow(us_soc), shape_row, shape_col))
for (i in 1:nrow(us_soc)) {
  basis_arr[i,,] <- matrix(basis_use[i,], nrow = shape_row, ncol = shape_col)
}
```






